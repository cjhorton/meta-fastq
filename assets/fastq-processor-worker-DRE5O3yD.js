(function(){"use strict";async function u(t){const e=new Uint8Array(await t.slice(0,2).arrayBuffer());return e[0]===31&&e[1]===139}async function*a(t){let e=!1;for(;!e;){const{done:r,value:s}=await t.read();e=r,s&&(yield s)}}async function*c(t){const e=t.stream().pipeThrough(new DecompressionStream("gzip")).pipeThrough(new TextDecoderStream).getReader();yield*a(e)}async function*m(t){const e=t.stream().pipeThrough(new TextDecoderStream).getReader();yield*a(e)}const o=0,l=1,f=2,d=3,p=/^[ACGTN]+$/i,N=/^[\x21-\x7E]+$/;function g(t){const e=t[o],r=t[l],s=t[f],n=t[d];return!e.startsWith("@")||!s.startsWith("+")||s.length>1||r.length<1||n.length<1||r.length!==n.length||!p.test(r)?!1:N.test(n)}const i=/^@(?<instrument>\w+):(?<runNumber>\d+):(?<flowcellId>[A-Za-z0-9-]+):(?<lane>\d+):(?<tile>\d+):(?<xPos>\d+):(?<yPos>\d+)(?::(?<umi>[ATGCN]+\+[ATGCN]+))?\s(?<read>[12]):(?<isFiltered>[YN]):(?<control>\d+):(?<index>([ATGCN]+(?:\+[ATGCN]+)?)|\d+)$/,h=t=>i.test(t),w=t=>{const e=i.exec(t.trim());if(!(e!=null&&e.groups))return null;const r=e.groups;return{instrument:r.instrument,runNumber:Number(r.runNumber),flowcellId:r.flowcellId,lane:Number(r.lane),tile:Number(r.tile),xPos:Number(r.xPos),yPos:Number(r.yPos),umi:r.umi,read:r.read==="2"?2:1,isFiltered:r.isFiltered==="Y",control:Number(r.control),index:r.index}},I=t=>t&&h(t)?"Illumina":"Unknown",y=(t,e)=>{const r=w(e[o]);return r?{file:t,status:"Done",platform:"Illumina",instrumentId:r.instrument,flowcellId:r.flowcellId,runNumber:r.runNumber,cycles:e[l].length,indexes:r.index,readNumber:r.read}:{file:t,status:"Error",error:"Expected Illumina header",platform:"Unknown"}},E=(t,e)=>({file:t,platform:"Unknown",status:e});self.onmessage=async t=>{const{file:e}=t.data;try{const s=await u(e)?c(e):m(e),n=await b(s);if(!n){self.postMessage({type:"error",fileName:e.name,error:"No reads found"});return}if(!g(n)){self.postMessage({type:"error",fileName:e.name,error:"Invalid read structure"});return}const T=x(e,n),R=A(T);self.postMessage(R)}catch(r){self.postMessage({type:"error",fileName:e.name,error:r.message})}};function A(t){return{type:"result",result:t}}async function b(t){const e=[];for await(const r of t){const s=r.split(`
`).map(n=>n.trim()).filter(Boolean);for(const n of s)if(e.push(n),e.length===4)break;if(e.length===4)break}return e.length===4?e:null}function x(t,e){switch(I(e[o])){case"Illumina":return y(t,e);default:return E(t,"Done")}}})();
