(function(){"use strict";async function I(n){const e=new Uint8Array(await n.slice(0,2).arrayBuffer());return e[0]===31&&e[1]===139}async function*d(n){let e=!1;for(;!e;){const{done:r,value:o}=await n.read();e=r,o&&(yield o)}}async function*h(n){const e=n.stream().pipeThrough(new DecompressionStream("gzip")).pipeThrough(new TextDecoderStream).getReader();yield*d(e)}async function*A(n){const e=n.stream().pipeThrough(new TextDecoderStream).getReader();yield*d(e)}const m=0,c=1,C=2,g=3,N=/^[ACGTN]+$/i,Z=/^[\x21-\x7E]+$/;function k(n){const e=n[m],r=n[c],o=n[C],l=n[g];return!e.startsWith("@")||!o.startsWith("+")||o.length>1||r.length<1||l.length<1||r.length!==l.length||!N.test(r)?!1:Z.test(l)}const f=/^@(?<instrument>\w+):(?<runNumber>\d+):(?<flowCellId>[A-Za-z0-9-]+):(?<lane>\d+):(?<tile>\d+):(?<xPos>\d+):(?<yPos>\d+)(?::(?<umi>[ATGCN]+\+[ATGCN]+))?\s(?<read>[12]):(?<isFiltered>[YN]):(?<control>\d+):(?<index>([ATGCN]+(?:\+[ATGCN]+)?)|\d+)$/,v=n=>f.test(n),x=n=>{const e=f.exec(n.trim());if(!(e!=null&&e.groups))return null;const r=e.groups;return{instrument:r.instrument,runNumber:Number(r.runNumber),flowCellId:r.flowCellId,lane:Number(r.lane),tile:Number(r.tile),xPos:Number(r.xPos),yPos:Number(r.yPos),umi:r.umi,read:r.read==="2"?2:1,isFiltered:r.isFiltered==="Y",control:Number(r.control),index:r.index}},y=n=>{if(!S(n))return null;const[e,...r]=n.slice(1).trim().split(" "),o={};for(const l of r){const[i,...p]=l.split("=");i&&p.length>0&&(o[i]=p.join("="))}return b(e,o)},O=n=>S(n),S=n=>{if(!n.startsWith("@"))return!1;const e=n.toLowerCase();return e.includes("runid=")&&(e.includes("sampleid=")||e.includes("sample_id="))&&e.includes("flow_cell_id=")},b=(n,e)=>({readId:n,runId:e.runid,sampleId:e.sampleid??e.sample_id,flowCellId:e.flow_cell_id,protocolGroupId:e.protocol_group_id,channel:e.ch?Number(e.ch):void 0,startTime:e.start_time,basecallModelVersionId:e.basecall_model_version_id,basecallGpu:e.basecall_gpu,barcode:e.barcode,barcodeAlias:e.barcode_alias,parentReadId:e.parent_read_id}),_=n=>n?v(n)?"Illumina":O(n)?"Nanopore":"Unknown":"Unknown",a={minIon:"MinION",gridIon:"GridION",promethIon:"PromethION",unknownNanopore:"Unknown"},t={miSeq:"MiSeq",iSeq:"iSeq",miniSeq:"MiniSeq",nextSeq1000_2000:"NextSeq 1000/2000",novaSeqX:"NovaSeq X",nextSeq:"NextSeq",novaSeq:"NovaSeq",hiSeqX:"HiSeq X",hiSeq3000:"HiSeq 3000",hiSeq4000:"HiSeq 4000",hiSeq2500:"HiSeq 2500",hiSeq1500:"HiSeq 1500",hiSeq2000:"HiSeq 2000",genomeAnalyzerIIx:"Genome Analyzer IIx",unknownIllumina:"Unknown"},w={unknown:"Unknown"};[...Object.values(t),...Object.values(a),...Object.values(w)];const $=[{pattern:/HWI-M\d+/,instruments:[t.miSeq]},{pattern:/M\d+/,instruments:[t.miSeq]},{pattern:/LH\d+/,instruments:[t.novaSeqX]},{pattern:/VH\d+/,instruments:[t.nextSeq1000_2000]},{pattern:/FS\d+/,instruments:[t.iSeq]},{pattern:/MN\d+/,instruments:[t.miniSeq]},{pattern:/NB\d+/,instruments:[t.nextSeq]},{pattern:/NS\d+/,instruments:[t.nextSeq]},{pattern:/NA\d+/,instruments:[t.novaSeq]},{pattern:/A\d+/,instruments:[t.novaSeq]},{pattern:/E\d+/,instruments:[t.hiSeqX]},{pattern:/K\d+/,instruments:[t.hiSeq3000,t.hiSeq4000]},{pattern:/J\d+/,instruments:[t.hiSeq3000]},{pattern:/D\d+/,instruments:[t.hiSeq2500]},{pattern:/HWI-D\d+/,instruments:[t.hiSeq2500]},{pattern:/C\d+/,instruments:[t.hiSeq1500]},{pattern:/HWI-C\d+/,instruments:[t.hiSeq1500]},{pattern:/SN\d+/,instruments:[t.hiSeq2000,t.hiSeq2500]},{pattern:/HWUSI/,instruments:[t.genomeAnalyzerIIx]},{pattern:/^.*$/,instruments:[t.unknownIllumina]}];function P(n){return M(n,$)}function M(n,e){for(const r of e)if(r.pattern.test(n))return r.instruments;return[w.unknown]}const s={standardOutput:"Standard Output",midOrHighOutput:"Mid or High Output",nano:"MiSeq Nano",micro:"MiSeq Micro",standardV2:"MiSeq Standard v2",standard:"MiSeq Standard",midOutput:"Mid Output",highOutput:"High Output",p1OrP2:"P1 or P2",p3:"P3",rapidRunV2:"Rapid Run (2-lane) v2",trueSeqV3:"TrueSeq v3",highOutputV3:"High Output v3",eightLaneV1:"8-lane v1",eightLane:"8-lane",spOrS1:"SP or S1",s2:"S2",s4:"S4",tenB:"10B",twentyFiveB:"25B",unknown:"Unknown"},u={mk1d:"Mk1D",promethIon:"PromethIon",flongle:"Flongle",unknown:"Unknown"},q={unknown:"Unknown"};[...Object.values(s),...Object.values(u),...Object.values(q)];const T=[{pattern:/^(?:BNT|BRB|BPC|BPG|BPA|BPL|BTR)[A-Z0-9]{5}-[A-Z0-9]{4}$/,flowCell:s.standardOutput,instruments:[t.iSeq]},{pattern:/^000H[A-Z0-9]{5}$/,flowCell:s.midOrHighOutput,instruments:[t.miniSeq]},{pattern:/^[A-Z0-9]{5}AF[A-Z0-9]{2}$/,flowCell:s.midOutput,instruments:[t.nextSeq]},{pattern:/^[A-Z0-9]{5}(?:AG|BG)[A-Z0-9]{2}$/,flowCell:s.highOutput,instruments:[t.nextSeq]},{pattern:/^[A-Z0-9]{7}M5$/,flowCell:s.p1OrP2,instruments:[t.nextSeq1000_2000]},{pattern:/^[A-Z0-9]{7}HV$/,flowCell:s.p3,instruments:[t.nextSeq1000_2000]},{pattern:/^H[A-Z0-9]{4}BGX[XY]$/,flowCell:s.highOutput,instruments:[t.nextSeq]},{pattern:/^[A-Z0-9]{5}BC[A-Z0-9]{2}$/,flowCell:s.rapidRunV2,instruments:[t.hiSeq2500]},{pattern:/^[A-Z0-9]{5}AC[A-Z0-9]{2}$/,flowCell:s.trueSeqV3,instruments:[t.hiSeq2500]},{pattern:/^[A-Z0-9]{5}AN[A-Z0-9]{2}$/,flowCell:s.highOutputV3,instruments:[t.hiSeq2500]},{pattern:/^[A-Z0-9]{5}BB[A-Z0-9]{2}$/,flowCell:s.eightLaneV1,instruments:[t.hiSeq3000,t.hiSeq4000]},{pattern:/^[A-Z0-9]{5}(?:AL|CC)[A-Z0-9]{2}$/,flowCell:s.eightLane,instruments:[t.hiSeqX]},{pattern:/^[A-Z0-9]{5}DR[A-Z0-9]{2}$/,flowCell:s.spOrS1,instruments:[t.novaSeq]},{pattern:/^[A-Z0-9]{5}DM[A-Z0-9]{2}$/,flowCell:s.s2,instruments:[t.novaSeq]},{pattern:/^[A-Z0-9]{5}DS[A-Z0-9]{2}$/,flowCell:s.s4,instruments:[t.novaSeq]},{pattern:/^[A-Z0-9]{6}LT3$/,flowCell:s.tenB,instruments:[t.novaSeqX]},{pattern:/^[A-Z0-9]{6}LT4$/,flowCell:s.twentyFiveB,instruments:[t.novaSeqX]},{pattern:/^[A-Z0-9]{6}LT[A-Z0-9]$/,flowCell:s.unknown,instruments:[t.novaSeqX]},{pattern:/^D[A-Z0-9]{4}$/,flowCell:s.nano,instruments:[t.miSeq]},{pattern:/^G[A-Z0-9]{4}$/,flowCell:s.micro,instruments:[t.miSeq]},{pattern:/^A[A-Z0-9]{4}$/,flowCell:s.standardV2,instruments:[t.miSeq]},{pattern:/^[BCJKL][A-Z0-9]{4}$/,flowCell:s.standard,instruments:[t.miSeq]},{pattern:/^.*$/,flowCell:s.unknown,instruments:[t.unknownIllumina]}],B=[{pattern:/^FAZ[A-Z0-9]+$/,flowCell:u.mk1d,instruments:[a.minIon]},{pattern:/^PAA[A-Z0-9]+$/,flowCell:u.promethIon,instruments:[a.promethIon]},{pattern:/^FAS[A-Z0-9]+$/,flowCell:u.flongle,instruments:[a.minIon,a.gridIon]}];function F(n){return H(n,T)}function H(n,e){const r=n.replace(/^000000000-/,"");for(const o of e)if(o.pattern.test(r))return o.flowCell;return q.unknown}const E=(n,e)=>{const r=x(e[m]);if(!r)return{file:n,status:"Error",error:"Expected Illumina header",platform:"Unknown"};const o=P(r.instrument),l=F(r.flowCellId);return{file:n,status:"Done",platform:"Illumina",instrumentId:r.instrument,instrumentTypes:o,flowCellId:r.flowCellId,flowCellType:l,runNumber:r.runNumber,cycles:e[c].length,indexes:r.index,readNumber:r.read}},G=(n,e)=>({file:n,platform:"Unknown",status:e}),L=(n,e)=>{const r=y(e[m]);if(!r)return{file:n,status:"Error",error:"Expected Nanopore header",platform:"Unknown"};const o=r.flowCellId??"",{flowCell:l,instruments:i}=R(o);return{file:n,status:"Done",platform:"Nanopore",instrumentTypes:i,flowCellId:r.flowCellId,flowCellType:l}},R=n=>{for(const e of B)if(e.pattern.test(n))return{flowCell:e.flowCell,instruments:e.instruments};return{flowCell:u.unknown,instruments:[a.unknownNanopore]}};self.onmessage=async n=>{const{file:e}=n.data;try{const o=await I(e)?h(e):A(e),l=await V(o);if(!l){self.postMessage({type:"error",fileName:e.name,error:"No reads found"});return}if(!k(l)){self.postMessage({type:"error",fileName:e.name,error:"Invalid read structure"});return}const i=D(e,l),p=U(i);self.postMessage(p)}catch(r){self.postMessage({type:"error",fileName:e.name,error:r.message})}};function U(n){return{type:"result",result:n}}async function V(n){const e=[];for await(const r of n){const o=r.split(`
`).map(l=>l.trim()).filter(Boolean);for(const l of o)if(e.push(l),e.length===4)break;if(e.length===4)break}return e.length===4?e:null}function D(n,e){switch(_(e[m])){case"Illumina":return E(n,e);case"Nanopore":return L(n,e);default:return G(n,"Done")}}})();
