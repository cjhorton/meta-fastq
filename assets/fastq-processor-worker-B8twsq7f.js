(function(){"use strict";async function S(t){const n=new Uint8Array(await t.slice(0,2).arrayBuffer());return n[0]===31&&n[1]===139}async function*u(t){let n=!1;for(;!n;){const{done:r,value:i}=await t.read();n=r,i&&(yield i)}}async function*c(t){const n=t.stream().pipeThrough(new DecompressionStream("gzip")).pipeThrough(new TextDecoderStream).getReader();yield*u(n)}async function*f(t){const n=t.stream().pipeThrough(new TextDecoderStream).getReader();yield*u(n)}const a=0,o=1,q=2,w=3,h=/^[ACGTN]+$/i,A=/^[\x21-\x7E]+$/;function I(t){const n=t[a],r=t[o],i=t[q],l=t[w];return!n.startsWith("@")||!i.startsWith("+")||i.length>1||r.length<1||l.length<1||r.length!==l.length||!h.test(r)?!1:A.test(l)}const m=/^@(?<instrument>\w+):(?<runNumber>\d+):(?<flowCellId>[A-Za-z0-9-]+):(?<lane>\d+):(?<tile>\d+):(?<xPos>\d+):(?<yPos>\d+)(?::(?<umi>[ATGCN]+\+[ATGCN]+))?\s(?<read>[12]):(?<isFiltered>[YN]):(?<control>\d+):(?<index>([ATGCN]+(?:\+[ATGCN]+)?)|\d+)$/,g=t=>m.test(t),C=t=>{const n=m.exec(t.trim());if(!(n!=null&&n.groups))return null;const r=n.groups;return{instrument:r.instrument,runNumber:Number(r.runNumber),flowCellId:r.flowCellId,lane:Number(r.lane),tile:Number(r.tile),xPos:Number(r.xPos),yPos:Number(r.yPos),umi:r.umi,read:r.read==="2"?2:1,isFiltered:r.isFiltered==="Y",control:Number(r.control),index:r.index}},N=t=>t&&g(t)?"Illumina":"Unknown",Z={minIon:"MinION",gridIon:"GridION",promethIon:"PromethION",unknownNanopore:"Unknown"},e={miSeq:"MiSeq",iSeq:"iSeq",miniSeq:"MiniSeq",nextSeq1000_2000:"NextSeq 1000/2000",novaSeqX:"NovaSeq X",nextSeq:"NextSeq",novaSeq:"NovaSeq",hiSeqX:"HiSeq X",hiSeq3000:"HiSeq 3000",hiSeq4000:"HiSeq 4000",hiSeq2500:"HiSeq 2500",hiSeq1500:"HiSeq 1500",hiSeq2000:"HiSeq 2000",genomeAnalyzerIIx:"Genome Analyzer IIx",unknownIllumina:"Unknown"},p={unknown:"Unknown"};[...Object.values(e),...Object.values(Z),...Object.values(p)];const O=[{pattern:/HWI-M\d+/,instruments:[e.miSeq]},{pattern:/M\d+/,instruments:[e.miSeq]},{pattern:/LH\d+/,instruments:[e.novaSeqX]},{pattern:/VH\d+/,instruments:[e.nextSeq1000_2000]},{pattern:/FS\d+/,instruments:[e.iSeq]},{pattern:/MN\d+/,instruments:[e.miniSeq]},{pattern:/NB\d+/,instruments:[e.nextSeq]},{pattern:/NS\d+/,instruments:[e.nextSeq]},{pattern:/NA\d+/,instruments:[e.novaSeq]},{pattern:/A\d+/,instruments:[e.novaSeq]},{pattern:/E\d+/,instruments:[e.hiSeqX]},{pattern:/K\d+/,instruments:[e.hiSeq3000,e.hiSeq4000]},{pattern:/J\d+/,instruments:[e.hiSeq3000]},{pattern:/D\d+/,instruments:[e.hiSeq2500]},{pattern:/HWI-D\d+/,instruments:[e.hiSeq2500]},{pattern:/C\d+/,instruments:[e.hiSeq1500]},{pattern:/HWI-C\d+/,instruments:[e.hiSeq1500]},{pattern:/SN\d+/,instruments:[e.hiSeq2000,e.hiSeq2500]},{pattern:/HWUSI/,instruments:[e.genomeAnalyzerIIx]},{pattern:/^.*$/,instruments:[e.unknownIllumina]}];function k(t){return x(t,O)}function x(t,n){for(const r of n)if(r.pattern.test(t))return r.instruments;return[p.unknown]}const s={standardOutput:"Standard Output",midOrHighOutput:"Mid or High Output",nano:"MiSeq Nano",micro:"MiSeq Micro",standardV2:"MiSeq Standard v2",standard:"MiSeq Standard",midOutput:"Mid Output",highOutput:"High Output",p1OrP2:"P1 or P2",p3:"P3",rapidRunV2:"Rapid Run (2-lane) v2",trueSeqV3:"TrueSeq v3",highOutputV3:"High Output v3",eightLaneV1:"8-lane v1",eightLane:"8-lane",spOrS1:"SP or S1",s2:"S2",s4:"S4",tenB:"10B",twentyFiveB:"25B",unknown:"Unknown"},v={mk1d:"Mk1D",promethIon:"PromethIon",flongle:"Flongle",unknown:"Unknown"},d={unknown:"Unknown"};[...Object.values(s),...Object.values(v),...Object.values(d)];const y=[{pattern:/^(?:BNT|BRB|BPC|BPG|BPA|BPL|BTR)[A-Z0-9]{5}-[A-Z0-9]{4}$/,flowCell:s.standardOutput,instruments:[e.iSeq]},{pattern:/^000H[A-Z0-9]{5}$/,flowCell:s.midOrHighOutput,instruments:[e.miniSeq]},{pattern:/^[A-Z0-9]{5}AF[A-Z0-9]{2}$/,flowCell:s.midOutput,instruments:[e.nextSeq]},{pattern:/^[A-Z0-9]{5}(?:AG|BG)[A-Z0-9]{2}$/,flowCell:s.highOutput,instruments:[e.nextSeq]},{pattern:/^[A-Z0-9]{7}M5$/,flowCell:s.p1OrP2,instruments:[e.nextSeq1000_2000]},{pattern:/^[A-Z0-9]{7}HV$/,flowCell:s.p3,instruments:[e.nextSeq1000_2000]},{pattern:/^H[A-Z0-9]{4}BGX[XY]$/,flowCell:s.highOutput,instruments:[e.nextSeq]},{pattern:/^[A-Z0-9]{5}BC[A-Z0-9]{2}$/,flowCell:s.rapidRunV2,instruments:[e.hiSeq2500]},{pattern:/^[A-Z0-9]{5}AC[A-Z0-9]{2}$/,flowCell:s.trueSeqV3,instruments:[e.hiSeq2500]},{pattern:/^[A-Z0-9]{5}AN[A-Z0-9]{2}$/,flowCell:s.highOutputV3,instruments:[e.hiSeq2500]},{pattern:/^[A-Z0-9]{5}BB[A-Z0-9]{2}$/,flowCell:s.eightLaneV1,instruments:[e.hiSeq3000,e.hiSeq4000]},{pattern:/^[A-Z0-9]{5}(?:AL|CC)[A-Z0-9]{2}$/,flowCell:s.eightLane,instruments:[e.hiSeqX]},{pattern:/^[A-Z0-9]{5}DR[A-Z0-9]{2}$/,flowCell:s.spOrS1,instruments:[e.novaSeq]},{pattern:/^[A-Z0-9]{5}DM[A-Z0-9]{2}$/,flowCell:s.s2,instruments:[e.novaSeq]},{pattern:/^[A-Z0-9]{5}DS[A-Z0-9]{2}$/,flowCell:s.s4,instruments:[e.novaSeq]},{pattern:/^[A-Z0-9]{6}LT3$/,flowCell:s.tenB,instruments:[e.novaSeqX]},{pattern:/^[A-Z0-9]{6}LT4$/,flowCell:s.twentyFiveB,instruments:[e.novaSeqX]},{pattern:/^[A-Z0-9]{6}LT[A-Z0-9]$/,flowCell:s.unknown,instruments:[e.novaSeqX]},{pattern:/^D[A-Z0-9]{4}$/,flowCell:s.nano,instruments:[e.miSeq]},{pattern:/^G[A-Z0-9]{4}$/,flowCell:s.micro,instruments:[e.miSeq]},{pattern:/^A[A-Z0-9]{4}$/,flowCell:s.standardV2,instruments:[e.miSeq]},{pattern:/^[BCJKL][A-Z0-9]{4}$/,flowCell:s.standard,instruments:[e.miSeq]},{pattern:/^.*$/,flowCell:s.unknown,instruments:[e.unknownIllumina]}];function $(t){return B(t,y)}function B(t,n){const r=t.replace(/^000000000-/,"");for(const i of n)if(i.pattern.test(r))return i.flowCell;return d.unknown}const M=(t,n)=>{const r=C(n[a]);if(!r)return{file:t,status:"Error",error:"Expected Illumina header",platform:"Unknown"};const i=k(r.instrument),l=$(r.flowCellId);return{file:t,status:"Done",platform:"Illumina",instrumentId:r.instrument,instrumentTypes:i,flowCellId:r.flowCellId,flowCellType:l,runNumber:r.runNumber,cycles:n[o].length,indexes:r.index,readNumber:r.read}},H=(t,n)=>({file:t,platform:"Unknown",status:n});self.onmessage=async t=>{const{file:n}=t.data;try{const i=await S(n)?c(n):f(n),l=await P(i);if(!l){self.postMessage({type:"error",fileName:n.name,error:"No reads found"});return}if(!I(l)){self.postMessage({type:"error",fileName:n.name,error:"Invalid read structure"});return}const F=b(n,l),E=T(F);self.postMessage(E)}catch(r){self.postMessage({type:"error",fileName:n.name,error:r.message})}};function T(t){return{type:"result",result:t}}async function P(t){const n=[];for await(const r of t){const i=r.split(`
`).map(l=>l.trim()).filter(Boolean);for(const l of i)if(n.push(l),n.length===4)break;if(n.length===4)break}return n.length===4?n:null}function b(t,n){switch(N(n[a])){case"Illumina":return M(t,n);default:return H(t,"Done")}}})();
